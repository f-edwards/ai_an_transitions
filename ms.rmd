---
title: The Processing of American Indian/Alaska Native Children through non-Tribal
  Child Welfare Systems
author: "Frank Edwards"
date: "12/12/2019"
output: html_document
---

```{r include=F}
rm(list=ls()); gc()
library(tidyverse)
library(lubridate)
source("lifetable.r")

pop<-read_csv("./data/pop_nat.csv")
afcars<-read_csv("./data/afcars_subset.csv",
                 col_types = cols(stfcid="c")) 

ncands<-read_csv("./data/ncands_subset.csv")



xwalk<-read_csv("./data/xwalk_merged.csv")

```

## OUTLINE

This report examines how american indian children are processed through us child welfare systems. it explores the likelihood that american indian children eventually end up in foster care, end up in foster care with non-indian foster parents, or see the rights of their parents terminated. I compare these pathways through the foster care system to the pathways experienced by white and African American children. 

I use the 2003 - 2016 AFCARS and NCANDS to calculate period lifetables for lifetime risk of investigation, substantiation, placement, placement into a non-ICWA compliant foster placement, and termination of parental rights. Each of these tables provides an estimate of the cumulative risk of experiencing the event before age 18 if risk-levels observed during the reported period remain constant.

## What am I estimating

1. Pr(investigation)
2. Pr(substantiated|investigation)
3. Pr(placement|substantiated), Pr(placement|investigation), Pr(placement)
4. Pr(non-indian FC|placement)
5. Pr(termination|placement)


A portrait of system involvement for AI/AN kids:

Lifetime risk of ever:
being investigated
being substantiated
being placed
being placed in non-native home
being placed in long-term care (>1yr)
being terminated

## $P(\textsf{investigation})$

Establish the probability that a child was ever investigated.

```{r ncandstables.pop}
### identify first report
ncands_first<-ncands %>% 
  select(.imp, race_ethn, stfcid, chage, rptdt) %>% 
  group_by(stfcid) %>% 
  filter(rptdt==min(rptdt)) %>% 
  ungroup() %>% 
  distinct() %>% 
  mutate(year = year(rptdt))

ncands_first_nat<-ncands_first %>% 
  group_by(.imp, race_ethn, chage, year) %>% 
  summarise(var = n()) %>% 
  ungroup() %>% 
  rename(age = chage) %>% 
  left_join(pop) %>% 
  filter(age < 18)

### run lifetable by year

investigation_tables<-list()
years<-unique(ncands_first_nat$year)
for(i in 1:length(years)){
  investigation_tables[[i]]<-make_life_table(ncands_first_nat %>% 
                  filter(year==years[i]))
}

investigation_tables<-bind_rows(investigation_tables) 

investigation_tables %>% 
  filter(age==17) %>% 
  ggplot(aes(x=year, y = c, color = race_ethn)) +
  geom_line()

### way lower rates in 17
### check total case counts
### counts are low, probably some non-reporting states, removing for now
```

## $P(substantiation)$

```{r fctables.ncands}
ncands_first<-ncands %>% 
  filter(rptvictim==1) %>% 
  group_by(chid) %>% 
  filter(rptdt==min(rptdt))

ncands_first_subst_nat<-ncands_first %>% 
  group_by(chage, year) %>% 
  summarise(var = n()) %>% 
  rename(age = chage) %>% 
  left_join(pop) %>% 
  ungroup()

### run lifetable by year

subst_tables<-list()
years<-unique(ncands_first_subst_nat$year)
for(i in 1:length(years)){
  subst_tables[[i]]<-make_life_table(ncands_first_subst_nat %>% 
                  filter(year==years[i]))
}

subst_tables<-bind_rows(subst_tables)
```

## $P(subst|inv)$

of all investigated, how many are ever substantiated?

from lifetables:

Because $P(inv|subst)=1$, and we've converted population incidence into annual age-adjusted probability, the ratio of events is the conditional probability

\[P(subst|inv) = \frac{d_{subst}}{d_{inv}}\]

```{r}

make_conditionals<-function(num, denom){
  out<-num %>% 
  select(age, year, d) %>% 
  rename(d_num = d) %>% 
  left_join(denom %>% 
              select(age, year, d) %>% 
              rename(d_denom = d)) %>% 
  group_by(year) %>% 
  summarise(q = sum(d_num)/sum(d_denom))
  return(out)
}

sub_inv<-make_conditionals(subst_tables, investigation_tables)

```

## $P(FC)$ using AFCARS

```{r fctables.pop}
### look at first fc placement
afcars_first <- afcars %>% 
  group_by(stfcid) %>% 
  filter(age == min(age) & year == min(year)) %>% 
  select(stfcid, age, year) %>% 
  distinct()
### this matches length(unique(afcars$stfcid))

afcars_first_nat<-afcars_first %>% 
  group_by(age, year) %>% 
  summarise(var = n()) %>% 
  left_join(pop) %>% 
  ungroup()

### run lifetable by year
fc_tables<-list()
years<-unique(afcars_first_nat$year)
for(i in 1:length(years)){
  fc_tables[[i]]<-make_life_table(afcars_first_nat %>% 
                  filter(year==years[i]))
}

fc_tables<-bind_rows(fc_tables)
```

## $P(FC)$ using NCANDS

```{r}
### look at first fc placement
ncands_first_fc <- ncands %>% 
  filter(!(is.na(afcarsid))) %>% 
  group_by(chid) %>% 
  filter(rptdt==min(rptdt)) %>% 
  select(chid, afcarsid, chage, year) %>% 
  ungroup() %>% 
  distinct()
### this matches length(unique(afcars$stfcid))

ncands_fc_nat<-ncands_first_fc %>% 
  rename(age = chage) %>% 
  group_by(age, year) %>% 
  summarise(var = n()) %>% 
  left_join(pop) %>% 
  ungroup()

### run lifetable by year
fc_tables<-list()
years<-unique(afcars_first_nat$year)
for(i in 1:length(years)){
  fc_tables[[i]]<-make_life_table(afcars_first_nat %>% 
                  filter(year==years[i]))
}

fc_tables<-bind_rows(fc_tables)
```


## $P(entered, investigation)$ using ncands
```{r fctables.ncands}
ncands_fc_first<-ncands %>% 
  filter(ever_entered==T) %>% 
  group_by(stfcid) %>% 
  filter(chage==min(chage)) %>% 
  ungroup() %>% 
  select(stfcid, year, chage) %>% 
  distinct()

ncands_fc_nat<-ncands_fc_first %>% 
  group_by(year, chage) %>% 
  summarise(var = n()) %>% 
  rename(age = chage) %>% 
  left_join(pop) %>% 
  ungroup()

### run lifetable by year
ncands_fc_tables<-list()
years<-unique(ncands_fc_nat$year)
for(i in 1:length(years)){
  ncands_fc_tables[[i]]<-make_life_table(ncands_fc_nat %>% 
                  filter(year==years[i]))
}

ncands_fc_tables<-bind_rows(ncands_fc_tables)
```

## $P(investigation , entered)$ using afcars

```{r}
### among all entries, match on investigation
### question is afcars or ncands on left for join
### likely assymetry
### need first inv date in ncands_xwalk
### to ensure I have inv prior to fc
### to obtain P(inv,entered) where entered occurs after inv

afcars_inv<-afcars_first %>% 
  left_join(ncands_xwalk %>% 
              select(stfcid, rptdt) %>% 
              mutate(ncands_inv = T))

afcars_inv<-afcars_inv %>% 
  ungroup() %>% 
  mutate(rpt_year = year(rptdt)) %>% 
  filter(!(is.na(ncands_inv))) 

## remove when year(rptdt)>year

afcars_inv<-afcars_inv %>% 
  filter(year>=rpt_year)



```


RECALL THAT

\[P(A|B) = \frac{P(A,B)}{P(B)}\]

ALSO, BAYES THEOREM

\[P(B|A) = \frac{P(A|B)P(B)}{P(A)}\]

for $A=FC$ and $B=investigation$, we wish to obtain $P(A|B)$. We obtain differing measurements of $P(A,B)$ from two datasets. I'll calculate each and compare. 

## $P(FC|inv)$

```{r}
fc_inv<-make_conditionals(fc_tables, investigation_tables)
fc_sub<-make_conditionals(fc_tables, subst_tables)
fc_ncands_inv<-make_conditionals(ncands_fc_tables, 
                                 investigation_tables)
fc_ncands_subst<-make_conditionals(ncands_fc_tables, 
                                 subst_tables)
```

NEXT: compare these to raw rates, 



Compare to lifetime risk of ever investigated

CONDITIONALS ONLY WORK FROM SAME DATA - CANT ASSUME THAT p(b|a)=1 otherwise

need to go back to original afcars - rely on imputed ncands to get uncertainty, link to afcars by id, check year for investigation incident, maybe +/-1 yr for lags in placement starts

want to use the proportions to obtain information about probability. perhaps use a model to populate uncertainty? or construct CI from data - either way should be ok


