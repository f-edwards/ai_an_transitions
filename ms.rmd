---
title: The Processing of American Indian/Alaska Native Children through non-Tribal
  Child Welfare Systems
author: "Frank Edwards"
date: "12/12/2019"
output: html_document
---

```{r include=F}
rm(list=ls()); gc()
library(tidyverse)
library(lubridate)
source("lifetable.r")

ncands_inv<-read_csv("./data/ncands_first_inv.csv") %>% 
  filter(year>=2003, year<2017) %>% 
  filter(age<18) %>% 
  filter(.imp!=0) %>% 
  filter(race_ethn == "AI/AN" | race_ethn == "White")
ncands_sub<-read_csv("./data/ncands_first_sub.csv")%>% 
  filter(year>=2003, year<2017)%>% 
  filter(age<18) %>% 
  filter(.imp!=0) %>% 
  filter(race_ethn == "AI/AN" | race_ethn == "White")
afcars_fc<-read_csv("./data/afcars_first_fc.csv")%>% 
  filter(year>=2003, year<2017)%>% 
  filter(age<18) %>%   
  filter(.imp!=0) %>% 
  filter(race_ethn == "AI/AN" | race_ethn == "White")
afcars_tpr<-read_csv("./data/afcars_tpr.csv")%>% 
  filter(year>=2003, year<2017)%>% 
  filter(age<18) %>% 
  filter(.imp!=0) %>% 
  filter(race_ethn == "AI/AN" | race_ethn == "White") 
afcars_non_icwa<-read_csv("./data/afcars_non_icwa.csv")%>% 
  filter(year>=2003, year<2017)%>% 
  filter(age<18) %>% 
  filter(.imp!=0) %>% 
  filter(race_ethn == "AI/AN" | race_ethn == "White")
afcars_fc_inv<-read_csv("./data/afcars_fc_post_inv.csv")%>% 
  filter(year>=2003, year<2017)%>% 
  filter(age<18) %>% 
  filter(.imp!=0) %>% 
  filter(race_ethn == "AI/AN" | race_ethn == "White")
```

## OUTLINE

This report examines how american indian children are processed through us child welfare systems. it explores the likelihood that american indian children eventually end up in foster care, end up in foster care with non-indian foster parents, or see the rights of their parents terminated. I compare these pathways through the foster care system to the pathways experienced by white and African American children. 

I use the 2003 - 2016 AFCARS and NCANDS to calculate period lifetables for lifetime risk of investigation, substantiation, placement, placement into a non-ICWA compliant foster placement, and termination of parental rights. Each of these tables provides an estimate of the cumulative risk of experiencing the event before age 18 if risk-levels observed during the reported period remain constant.

## What am I estimating

This report examines how American Indian and Alaska Native children are processed through US child welfare systems. It explores the likelihood that American Indian children eventually end up in foster care, end up in foster care with non-indian foster parents, or see the rights of their parents terminated. I compare these pathways through the foster care system to the pathways experienced by white and African American children. 

I use the 2003 - 2016 AFCARS and NCANDS to calculate period lifetables for lifetime risk of investigation, substantiation, placement, placement into a non-ICWA compliant foster care settings, and termination of parental rights. Each of these tables provides an estimate of the cumulative risk of experiencing the event before age 18 if risk-levels observed during the reported period remain constant.

This report pays particular attention to the probability of particular case processing decisions for AI/AN children, conditional on prior decision points. In doing so, we can begin to zoom-in on whether inequalities for AI/AN children emerge at particular decision points. The first component of the report provides national estimates of the following probabilities

1. $Pr(investigation)$
2. $Pr(substantiated|investigation)$
3. $Pr(placement)$
3. $Pr(placement|investigation)$
4. $Pr(placement|substantiation)$
4. $Pr(\textsf{ICWA non-compliant placement}|placement)$
4. $Pr(\textsf{long-term placement}|placement)$
5. $Pr(termination|placement)$

In doing so, this report provides a portrait of child-welfare system involvement for American Indian/Alaska Native children at the national level. Future versions of this report will detail sub-national variation. Sub-national estimates can be coupled with relevant system-level or child-level data to help evaluate which features of places are associated with investigation, substantiation, placement, and termination decisions for AI/AN children and families.

In each section, I first explore how risk has shifted over time with an exploration of national trends in lifetime risk between 2003 and 2016. Next, I provide detailed estimates of risk for the 2012 - 2016 period with an emphasis on both lifetime and age-specific risks.

In contrast to per capita event rates, life table estimates allow us to simulate the incidence of an event over the course of a child's life. These estimates adjust for variable age-specific risk and population size to provide a more comprehensive single estimate of event incidence in the population. 

## Investigations

What proportion of AI/AN children are likely to experience a child welfare system investigation during the course of their childhood? I examine the child-level probability of ever experiencing an investigation by examining the proportion of children in each year of the data that experience their first maltreatment investigation, then using these numbers to construct period life tables, first as annual tables, and second as a grouped 2012 - 2016 table (which stabilizes trends driven by small age-specific event counts).

```{r ncandstables.pop}
### read in new first investigation csv
### run lifetable by year

investigation_tables<-list()
years<-unique(ncands_inv$year)
race_ethn<-unique(ncands_inv$race_ethn)
index<-1
for(i in 1:5){
  for(j in 1:length(years)){
    for(r in 1:length(race_ethn)){
      temp<-ncands_inv %>% 
        filter(year==years[j])
      temp<-temp %>% 
        filter(race_ethn == race_ethn[r])
      temp<-temp %>% 
        filter(.imp==i)
      investigation_tables[[index]]<-make_life_table(temp)
      index<-index+1
    }
  }
}
investigation_tables<-bind_rows(investigation_tables)

investigation_tables_c<-investigation_tables %>% 
  filter(age==17) %>% 
  group_by(year, race_ethn) %>% 
  summarise(c_mn = mean(c), cmax = max(c), cmin = min(c))

investigation_tables_c %>% 
  ggplot(aes(x=year, y = c_mn, 
             fill = race_ethn,
             group = race_ethn,
             ymin = cmin, ymax = cmax)) +
  geom_ribbon(alpha = .5) + 
  geom_line(aes(color = race_ethn)) + 
  xlab("Year") + 
  ylab("Proportion with screened-in report before age 18")

### way lower rates in 17
### check total case counts
### counts are low, probably some non-reporting states, removing for now
```

FIG 1: TS plot of age 17 cumulative investigation risk by year

VISUALIZE investigation tables

## $P(substantiation)$

```{r}


### run lifetable by year
subst_tables<-list()
years<-unique(ncands_sub$year)
race_ethn<-unique(ncands_sub$race_ethn)
index<-1
for(i in 1:5){
  for(j in 1:length(years)){
    for(r in 1:length(race_ethn)){
      temp<-ncands_sub %>% 
        filter(year==years[j])
      temp<-temp %>% 
        filter(race_ethn == race_ethn[r])
      temp<-temp %>% 
        filter(.imp==i)
      subst_tables[[index]]<-make_life_table(temp)
      index<-index+1
    }
  }
}
subst_tables<-bind_rows(subst_tables)

subst_tables_c<-subst_tables %>% 
  filter(age==17) %>% 
  group_by(year, race_ethn) %>% 
  summarise(c_mn = mean(c), cmax = max(c), cmin = min(c))

subst_tables_c %>% 
  ggplot(aes(x=year, y = c_mn, 
             fill = race_ethn,
             group = race_ethn,
             ymin = cmin, ymax = cmax)) +
  geom_ribbon(alpha = .5) + 
  geom_line(aes(color = race_ethn)) + 
  xlab("Year") + 
  ylab("Proportion with substantiation before age 18")
```


## $P(FC)$ using AFCARS

```{r fctables.pop}
fc_tables<-list()
years<-unique(afcars_fc$year)
race_ethn<-unique(afcars_fc$race_ethn)
index<-1
for(i in 1:length(afcars_fc$.imp)){
  for(j in 1:length(years)){
    for(r in 1:length(race_ethn)){
      temp<-afcars_fc %>% 
        filter(year==years[j])
      temp<-temp %>% 
        filter(race_ethn == race_ethn[r])
      temp<-temp %>% 
        filter(.imp==i)
      fc_tables[[index]]<-make_life_table(temp)
      index<-index+1
    }
  }
}
fc_tables<-bind_rows(fc_tables)

fc_tables_c<-fc_tables %>% 
  filter(age==17) %>% 
  group_by(year, race_ethn) %>% 
  summarise(c_mn = mean(c), cmax = max(c), cmin = min(c))

fc_tables_c %>% 
  ggplot(aes(x=year, y = c_mn, 
             fill = race_ethn,
             group = race_ethn,
             ymin = cmin, ymax = cmax)) +
  geom_ribbon(alpha = .5) + 
  geom_line(aes(color = race_ethn)) + 
  xlab("Year") + 
  ylab("Proportion ever in foster care before age 18")
```

## $P(investigation , entered)$ using afcars

```{r}
fc_post_inv_tables<-list()
years<-unique(afcars_fc_inv$year)
race_ethn<-unique(afcars_fc_inv$race_ethn)
index<-1
for(i in 1:length(afcars_fc_inv$.imp)){
  for(j in 1:length(years)){
    for(r in 1:length(race_ethn)){
      temp<-afcars_fc_inv %>% 
        filter(year==years[j])
      temp<-temp %>% 
        filter(race_ethn == race_ethn[r])
      temp<-temp %>% 
        filter(.imp==i)
      fc_post_inv_tables[[index]]<-make_life_table(temp)
      index<-index+1
    }
  }
}
fc_post_inv_tables<-bind_rows(fc_post_inv_tables)

fc_post_inv_tables_c<-fc_post_inv_tables %>% 
  filter(age==17) %>% 
  group_by(year, race_ethn) %>% 
  summarise(c_mn = mean(c), cmax = max(c), cmin = min(c))

fc_post_inv_tables_c %>% 
  ggplot(aes(x=year, y = c_mn, 
             fill = race_ethn,
             group = race_ethn,
             ymin = cmin, ymax = cmax)) +
  geom_ribbon(alpha = .5) + 
  geom_line(aes(color = race_ethn)) + 
  xlab("Year") + 
  ylab("Proportion with foster care entry after screened-in report")


```


RECALL THAT

\[P(A|B) = \frac{P(A,B)}{P(B)}\]

ALSO, BAYES THEOREM

\[P(B|A) = \frac{P(A|B)P(B)}{P(A)}\]

for $A=FC$ and $B=investigation$, we wish to obtain $P(A|B)$. We obtain differing measurements of $P(A,B)$ from two datasets. I'll calculate each and compare. 



## p(tpr)

```{r}
tpr_tables<-list()
years<-unique(afcars_tpr$year)
race_ethn<-unique(afcars_tpr$race_ethn)
index<-1
for(i in 1:length(afcars_tpr$.imp)){
  for(j in 1:length(years)){
    for(r in 1:length(race_ethn)){
      temp<-afcars_tpr %>% 
        filter(year==years[j])
      temp<-temp %>% 
        filter(race_ethn == race_ethn[r])
      temp<-temp %>% 
        filter(.imp==i)
      tpr_tables[[index]]<-make_life_table(temp)
      index<-index+1
    }
  }
}
tpr_tables<-bind_rows(tpr_tables)

tpr_tables_c<-tpr_tables %>% 
  filter(age==17) %>% 
  group_by(year, race_ethn) %>% 
  summarise(c_mn = mean(c), cmax = max(c), cmin = min(c))

tpr_tables_c %>% 
  ggplot(aes(x=year, y = c_mn, 
             fill = race_ethn,
             group = race_ethn,
             ymin = cmin, ymax = cmax)) +
  geom_ribbon(alpha = .5) + 
  geom_line(aes(color = race_ethn)) + 
  xlab("Year") + 
  ylab("Proportion with parental rights terminated")
```

## P(sub|inv)

```{r}

## p(sub|inv) = p(inv|sub) * p(sub) / p(inv) =
## p(sub) / p(inv)
ncands_sub_inv<-subst_tables %>% 
  mutate(sub_inv = q / investigation_tables$q)

ggplot(ncands_sub_inv %>% 
         filter(year==2016),
         aes(x = age, y = sub_inv, color = race_ethn)) + 
  geom_line()
```


## $P(FC|inv)$

\[p(fc|inv) = \frac{p(fc, inv)}{p(inv)}\]

```{r}
fc_cond_inv<-fc_post_inv_tables %>% 
  mutate(fc_inv = q / investigation_tables$q)

ggplot(fc_cond_inv %>% 
         filter(year==2016),
         aes(x = age, y = fc_inv, color = race_ethn)) + 
  geom_line()
```

## P(FC|sub)
```{r}

fc_cond_sub<-fc_post_inv_tables %>% 
  mutate(fc_sub = q / subst_tables$q)

ggplot(fc_cond_sub %>% 
         filter(year==2016),
         aes(x = age, y = fc_sub, color = race_ethn)) + 
  geom_line()
```

## P(FC|tpr)
```{r}
### use bayes' rule because p(fc|tpr)=1
# \[P(B|A) = \frac{P(A|B)P(B)}{P(A)}\]
## P(tpr|fc) = p(fc|tpr)p(tpr) / p(fc)
## p(tpr|fc) = p(tpr)/p(fc)
fc_tpr_fc<-tpr_tables %>% 
  mutate(tpr_fc = q/ fc_tables$q)

ggplot(fc_tpr_fc %>% 
         filter(year==2016),
         aes(x = age, y = tpr_fc, color = race_ethn)) + 
  geom_line()

```


NEXT: compare these to raw rates, 



Compare to lifetime risk of ever investigated

CONDITIONALS ONLY WORK FROM SAME DATA - CANT ASSUME THAT p(b|a)=1 otherwise

need to go back to original afcars - rely on imputed ncands to get uncertainty, link to afcars by id, check year for investigation incident, maybe +/-1 yr for lags in placement starts

want to use the proportions to obtain information about probability. perhaps use a model to populate uncertainty? or construct CI from data - either way should be ok


